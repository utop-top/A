worker_processes auto;
worker_rlimit_nofile 62525;
worker_cpu_affinity auto;
pcre_jit on;
load_module /usr/lib/nginx/modules/ngx_http_acme_module.so;  #自动证书模块

# Events Configuration
events {
  multi_accept on;
  worker_connections 65535;
  use epoll;
}

#  include stream.conf;

http {

# nginx 配置为由内到外原则，在location 中设置后，外部规则则失效
# =============================>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
#                              全局 HTTP 块优化
# =============================>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> 
# 安全性设置
server_tokens off;

# TLS 协议与加密套件（兼容现代客户端）
ssl_protocols TLSv1.2 TLSv1.3;
ssl_ciphers 'TLS_AES_256_GCM_SHA384:TLS_AES_128_GCM_SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
ssl_prefer_server_ciphers on;
ssl_session_cache shared:SSL_HTTP:50m;
ssl_session_timeout 1h;
ssl_session_tickets off;
# ssl_stapling on;
# ssl_stapling_verify on;


    # 开启 TLS 1.3 (HTTP/3 必须)

    # 通用优化配置
    ssl_early_data on;      # 开启 0-RTT
    quic_retry on;          # 开启 QUIC 重试机制
    quic_gso on;            # 开启 Generic Segmentation Offload (推荐)

# ============== 性能与连接优化  ===============
# 提高连接性能
sendfile on;
tcp_nodelay on;
tcp_nopush on;

# 长连接参数（高并发建议）
keepalive_timeout 75s;
keepalive_requests 5000;

# 缓冲区优化
client_body_buffer_size 512k;
client_header_buffer_size 8k;
client_max_body_size 8000m; # 同 Synapse 上传限制

# HTTP/2 优化
http2_max_concurrent_streams 512;


# Proxy 缓冲与超时
proxy_buffer_size 256k;
proxy_buffers 8 256k;
proxy_busy_buffers_size 512k;

# 关键连接超时
proxy_connect_timeout 60s;
proxy_send_timeout 300s;
proxy_read_timeout 300s;
proxy_ignore_client_abort on;

# 开启 HTTP/1.1 长连接支持
proxy_http_version 1.1;
proxy_set_header Connection "";

# ============== 压缩  ===============
gzip on;
gzip_comp_level 6;
gzip_min_length 256;
gzip_proxied any;
gzip_vary on;
gzip_buffers 32 16k;
gzip_types
    text/plain
    text/css
    text/javascript
    application/javascript
    application/json
    application/xml
    application/xml+rss
    image/svg+xml;

# =============================
# 可选：更现代的压缩（zstd/br）
# =============================
# brotli on;
# brotli_comp_level 6;
# brotli_static on;
# brotli_types text/plain text/css application/json application/javascript application/xml image/svg+xml;


##>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
  # HTTP-level includes
  map $host $log_filename {
        hostnames; # 优化主机名匹配性能
        rs.aosn.de access-rs-aosn.log; # rs.aosn.de 的日志文件
        default    access-default.log; # 所有其他域名（包括未知的或 IP 访问）的日志文件
    }
    # 定义日志格式（可选，但推荐使用）
    log_format combined_log '$remote_addr - $remote_user [$time_local] "$request" '
                            '$status $body_bytes_sent "$http_referer" '
                            '"$http_user_agent" "$http_x_forwarded_for"';

# =============================  DNS 解析
# 建议同时启用 IPv6（因为你服务器支持 IPv6）
# 这样 resolver 会优先选择 IPv6 通路
resolver  8.8.8.8 1.1.1.1 valid=300s ipv6=on;
resolver_timeout 5s;
# 定义 ACME 颁发者（例如 Let's Encrypt）
acme_issuer letsencrypt {
    uri         https://acme-v02.api.letsencrypt.org/directory;
    contact     mailto:looksend@outlook.com;
    state_path  /var/cache/nginx/acme-letsencrypt;
    accept_terms_of_service;
}

# ACME 使用的共享内存
acme_shared_zone zone=ngx_acme_shared:5M;


# ACME 证书获取端点
server {
    listen 8083;
    server_name _;  # 替换为你的域名
    # ACME 证书挑战路径
    location /.well-known/acme-challenge/ {
        root /var/www/letsencrypt;  # 挑战文件目录（需预创建：mkdir -p /var/www/letsencrypt）
        allow all;
        try_files $uri $uri/ =404;
    }
    # 其他所有请求：301 永久重定向到 HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# =============================
# http3
# =============================
 include http3_default_server.conf;

  include acme.conf;





# 挂载server 

  include /etc/nginx/server/other.conf;
  include /etc/nginx/server/m2.conf;
#  include /etc/nginx/server/m4.conf;
  include /etc/nginx/server/rtc.conf;

#  include /etc/nginx/server/t1.conf;
#    include /etc/nginx/server/mp.conf;

  include /etc/nginx/server/r2.conf;

  include /etc/nginx/server/tuwunel.conf;

 



    



  }