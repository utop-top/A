upstream matrix_m {
    server m.aosn.de:443;
    keepalive 64;
}

upstream matrix_app {
    server app.aosn.de:443;
    keepalive 64;
}
upstream matrix_account {
    server account.aosn.de:443;
    keepalive 32;
}

upstream matrix_admin {
    server admin.aosn.de:443;
    keepalive 32;
}

# 在 http {} 块中添加，用于自动处理 WebSocket Upgrade 头
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

server {
    gzip off;
    include ssl.conf;
    server_name m2.aosn.de;

    acme_certificate letsencrypt;
    ssl_certificate       $acme_certificate;
    ssl_certificate_key   $acme_certificate_key;

    # 避免每次请求都重新解析证书
    ssl_certificate_cache max=2;
    charset utf-8;


    # Matrix client routes for login/logout/refresh
    location ~ ^/_matrix/client/(.*)/(login|logout|refresh) {
        proxy_pass https://matrix_account; # 代理到 account 服务器
        proxy_set_header Host account.aosn.de;
        proxy_ssl_name account.aosn.de;
        proxy_ssl_server_name on;
 
        include matrix_proxy.conf;
    }


    # Matrix Client API 代理
    location ~ ^(/_matrix|/_synapse) {

        proxy_pass https://matrix_m; # 代理到 Matrix Synapse 服务器
        proxy_set_header Host m.aosn.de;
        proxy_ssl_name m.aosn.de;
        proxy_ssl_server_name on;


        include matrix_proxy.conf;

    }

    location / {
        return 404;
    }
    location /.well-known/matrix/server {
        default_type application/json;  # 设置返回类型为 JSON   联邦通讯
        add_header Access-Control-Allow-Origin *;  # 允许跨域访问
        return 200 '{"m.server": "m.aosn.de:443"}';  
    }
    location /.well-known/matrix/client {
        access_log off;
        add_header Access-Control-Allow-Origin *;
        default_type application/json;
        return 200 '{"m.homeserver": {"base_url": "https://m2.aosn.de"},"m.identity_server": {"base_url": "https://vector.im"},
                                       "org.matrix.msc2965.authentication":{"issuer":"https://account.aosn.de/","account":"https://account.aosn.de/account"},
                                       "org.matrix.msc4143.rtc_foci": [{"type": "livekit", "livekit_service_url": "https://m2rtc.aosn.de"}]}';
    }

    location /.well-known/element {
        default_type application/json;  
        add_header Access-Control-Allow-Origin *;  # 允许跨域访问
        return 200 '{"call":{"widget_url":"https://call.aosn.de"}}'; 
    }

}

server {
    gzip off;
    include ssl.conf;
    server_name ms.aosn.de;

    acme_certificate letsencrypt;
    ssl_certificate       $acme_certificate;
    ssl_certificate_key   $acme_certificate_key;

    # 避免每次请求都重新解析证书
    ssl_certificate_cache max=2;
    charset utf-8;


    # Matrix client routes for login/logout/refresh
    location ~ ^/_matrix/client/(.*)/(login|logout|refresh) {
        proxy_pass https://matrix_account; # 代理到 account 服务器
        proxy_set_header Host account.aosn.de;
        proxy_ssl_name account.aosn.de;
        proxy_ssl_server_name on;
 
        include matrix_proxy.conf;
    }


    # Matrix Client API 代理
    location ~ ^(/_matrix|/_synapse) {

        proxy_pass https://matrix_m; # 代理到 Matrix Synapse 服务器
        proxy_set_header Host m.aosn.de;
        proxy_ssl_name m.aosn.de;
        proxy_ssl_server_name on;


        include matrix_proxy.conf;

    }

    location / {
        return 404;
    }
    location /.well-known/matrix/server {
        default_type application/json;  # 设置返回类型为 JSON   联邦通讯
        add_header Access-Control-Allow-Origin *;  # 允许跨域访问
        return 200 '{"m.server": "m.aosn.de:443"}';  
    }
    location /.well-known/matrix/client {
        access_log off;
        add_header Access-Control-Allow-Origin *;
        default_type application/json;
        return 200 '{"m.homeserver": {"base_url": "https://ms.aosn.de"},"m.identity_server": {"base_url": "https://vector.im"},
                                       "org.matrix.msc2965.authentication":{"issuer":"https://account.aosn.de/","account":"https://account.aosn.de/account"},
                                       "org.matrix.msc4143.rtc_foci": [{"type": "livekit", "livekit_service_url": "https://m2rtc.aosn.de"}]}';
    }

    location /.well-known/element {
        default_type application/json;  
        add_header Access-Control-Allow-Origin *;  # 允许跨域访问
        return 200 '{"call":{"widget_url":"https://call.aosn.de"}}'; 
    }

}

server {
    gzip off;
    include ssl.conf;
    server_name apps.aosn.de;
    server_tokens off;

    charset utf-8;
    # SSL configuration with ACME
    acme_certificate letsencrypt;
    ssl_certificate $acme_certificate;
    ssl_certificate_key $acme_certificate_key;
    ssl_certificate_cache max=2;

    location / {
        proxy_pass https://matrix_app; # 代理到 Matrix Synapse 服务器
        proxy_set_header Host app.aosn.de;
        proxy_ssl_name app.aosn.de;
        proxy_ssl_server_name on;

        include matrix_proxy.conf;
    }


}

server {
    gzip off;
    include ssl.conf;
    server_name accounts.aosn.de;
    server_tokens off;

    charset utf-8;
    # SSL configuration with ACME
    acme_certificate letsencrypt;
    ssl_certificate $acme_certificate;
    ssl_certificate_key $acme_certificate_key;
    ssl_certificate_cache max=2;

    location / {
        proxy_pass https://matrix_account; # 代理到 Matrix Synapse 服务器
        proxy_set_header Host account.aosn.de;
        proxy_ssl_name account.aosn.de;
        proxy_ssl_server_name on;

        include matrix_proxy.conf;
    }


}

server {
    gzip off;
    include ssl.conf;
    server_name admins.aosn.de;
    server_tokens off;

    charset utf-8;
    # SSL configuration with ACME
    acme_certificate letsencrypt;
    ssl_certificate $acme_certificate;
    ssl_certificate_key $acme_certificate_key;
    ssl_certificate_cache max=2;

    location / {
        proxy_pass https://matrix_admin; # 代理到 Matrix Synapse 服务器
        proxy_set_header Host admin.aosn.de;
        proxy_ssl_name admin.aosn.de;
        proxy_ssl_server_name on;

        include matrix_proxy.conf;
    }


}


