map $http_upgrade $connection_upgrade_keepalive {
    default upgrade;
    ''      "";
}

upstream matrix_rs {
    server r.aosn.de:443;
    keepalive 64; # 保持 64 个空闲长连接
}

# 缓存路径配置 
proxy_cache_path /var/cache/nginx/matrix_media
    levels=1:2
    keys_zone=matrix_media:50m
    max_size=10g
    inactive=30d
    use_temp_path=off;

server {
    include ssl.conf;
    server_name rs.aosn.de;
    server_tokens off;
    charset utf-8;

    # SSL configuration (保持你的 ACME 配置不变)
    acme_certificate letsencrypt;
    ssl_certificate $acme_certificate;
    ssl_certificate_key $acme_certificate_key;
    ssl_certificate_cache max=2;

    # === [优化 1] 媒体文件代理 ===
    location ~ ^/_matrix/media/v3/(thumbnail|download) {
        proxy_pass https://matrix_rs;
        
        # SNI 和 Host 设置
        proxy_set_header Host r.aosn.de;
        proxy_ssl_name r.aosn.de;
        proxy_ssl_server_name on;
        
        # 缓存设置
        proxy_cache matrix_media;
        proxy_cache_key $uri$is_args$args;
        proxy_cache_valid 200 206 7d;
        proxy_cache_lock on;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;

        # === [核心修复] 这里必须也加上 Keep-Alive ===
        # 否则媒体请求全是短连接，性能极差！
        proxy_http_version 1.1;
        proxy_set_header Connection ""; 
        # 媒体文件一般不需要 Upgrade 头，直接设为空即可
        # ==========================================
    }

    # === [优化 2] 主 API 代理 ===
    location / {
        proxy_pass https://matrix_rs;
        
        # SNI 和 Host 设置
        proxy_set_header Host r.aosn.de;
        proxy_ssl_name r.aosn.de;
        proxy_ssl_server_name on;

        # SSL 优化
        proxy_ssl_protocols TLSv1.2 TLSv1.3;
        proxy_ssl_session_reuse on; # 复用 SSL 会话，极大减少握手耗时

        # 标准头
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Early-Data $ssl_early_data;
        proxy_set_header Authorization $http_authorization;

        # === Keep-Alive 与 WebSocket ===
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade_keepalive;

        # 性能与超时
        proxy_buffering off; # 适合 Matrix Sync 长轮询
        proxy_connect_timeout 60s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
        proxy_ignore_client_abort on;
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
        
        client_max_body_size 3000m;
    }

    # === 联邦委托 ===
    location /.well-known/matrix/server {
        default_type application/json;
        add_header Access-Control-Allow-Origin *;
        return 200 '{"m.server": "r.aosn.de:443"}';  
    }

    # === 客户端委托 ===
    location /.well-known/matrix/client {
        access_log off;
        add_header Access-Control-Allow-Origin *;
        default_type application/json;
        return 200 '{"m.homeserver": {"base_url": "https://rs.aosn.de"},"m.identity_server": {"base_url": "https://vector.im"},"org.matrix.msc4143.rtc_foci": [{"type": "livekit", "livekit_service_url": "https://m2rtc.aosn.de"}]}';
    }

    location /.well-known/element {
        default_type application/json;
        add_header Access-Control-Allow-Origin *;
        return 200 '{"call":{"widget_url":"https://call.aosn.de"}}';
    }
}
